#ifndef _MIDICVINTERFACE_H_
#define _MIDICVINTERFACE_H_


#define CV2_PIN      5
#define CV3_PIN      6
#define GATE1_PIN    7
#define GATE2_PIN    8
#define REF_NOTE    36
#define NOTE_RANGE  60

class MidiCVInterface : public MidiInterface {

public:
  void init(){
  pinMode(CV2_PIN, OUTPUT);
  pinMode(CV3_PIN, OUTPUT);
  pinMode(LED1_PIN, OUTPUT);
  pinMode(LED2_PIN, OUTPUT);
  pinMode(GATE1_PIN, OUTPUT);
  pinMode(GATE2_PIN, OUTPUT);

  dac.init();
  }

uint16_t note_to_cv(uint8_t note){
  return (note-REF_NOTE)*factor; 
}

// scale min-max to min2-max2: 
// value = min2 + (value - min) * (max2 - min2) / (max - min)

int16_t pitchbend_to_cv(uint16_t pb){
  //  scale 0, 16383 to -2, 2 semitones
  //   return value*4*factor/16384 - 2*factor;
  return pb*factor/4096 - 2*factor;
  // with a factor of 0x59, an unsigned 16 bit value overflows at 736
}  


void channelPressure(int value){
  if(value)
    digitalWrite(LED1_PIN, HIGH);
  else
    digitalWrite(LED1_PIN, LOW);
}

void startSong(){
  digitalWrite(GATE2_PIN, HIGH);
}

void stopSong(){
  digitalWrite(GATE2_PIN, LOW);
}

void midiClock(){
  digitalWrite(GATE2_PIN, HIGH);
  digitalWrite(GATE2_PIN, LOW);
}

/*
  Standard MIDI Files use a pitch wheel range of +/-2 semitones = 200 cents. MIDI pitch bend wheel resolution (according to the spec) is +8192/-8191. That means there are 8192/200 = 40.96 pitch bend units to 1 cent
*/
/*
  The two bytes of the pitch bend message form a 14 bit number, 0 to 16383. The value 8192 (sent, LSB first, as 0x00 0x40), is centered, or "no pitch bend."
*/
void pitchBend(int16_t value){
  cv1 += pitchbend_to_cv(value);
}

void controlChange(int cc, int value){
  //  if(cc == 1)
  cv3 = value << 2;
}

void noteOff(int note, int velocity){
  if(note < REF_NOTE || note > REF_NOTE+NOTE_RANGE)
    return;
  if(--keydowns)
    return; // there are still some keys pressed
  cv2 = velocity;
  digitalWrite(GATE1_PIN, LOW);
  digitalWrite(LED2_PIN, LOW);
}

void noteOn(int note, int velocity){
  if(note < REF_NOTE || note >= REF_NOTE+NOTE_RANGE)
    return;

  if(velocity == 0)
    return noteOff(note, velocity);

  //  1v/octave with 0-5v means 5 octave, 60 semitone range.
  // scale REF_NOTE - REF_NOTE+60 to 0-4096 (12 bits)
  cv1 = note_to_cv(note);
  cv2 = velocity<<2;

  dac.send(cv1);
  //   spi_send(cv1);

  if(keydowns++ && staccato)
    digitalWrite(GATE1_PIN, LOW);
  digitalWrite(GATE1_PIN, HIGH);
  digitalWrite(LED2_PIN, HIGH);
}

private:

uint16_t cv1;
uint8_t cv2, cv3;
int keydowns;
bool staccato = true;

  MCP492xController dac;
  uint8_t factor = 0x59; 
};



#endif /* _MIDICVINTERFACE_H_ */
